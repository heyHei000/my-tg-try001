<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å…³é”®ï¼šå¿…é¡»æ·»åŠ  viewport metaï¼Œå¦åˆ™åœ¨æ‰‹æœºä¸Šå­—ä¼šå¾ˆå° -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„æ•°æ®é¢æ¿</title>
    <!-- å¼•å…¥ Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        body {
            /* ä½¿ç”¨ Telegram æä¾›çš„åŸç”Ÿå˜é‡ï¼Œè‡ªåŠ¨é€‚é…æ·±è‰²/æµ…è‰²æ¨¡å¼ */
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .card {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .data-item {
            text-align: center;
        }

        .data-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #2481cc);
        }

        .data-label {
            font-size: 12px;
            opacity: 0.7;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }

        /* è°ƒè¯•é¢æ¿æ ·å¼ */
        .debug-panel {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .debug-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .debug-log {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #2481cc;
            background-color: rgba(36, 129, 204, 0.1);
            word-break: break-all;
        }

        .debug-error {
            border-left-color: #ff4444;
            background-color: rgba(255, 68, 68, 0.1);
            color: #ff4444;
        }

        .debug-success {
            border-left-color: #44ff44;
            background-color: rgba(68, 255, 68, 0.1);
            color: #44ff44;
        }

        .debug-toggle {
            background-color: #666;
            font-size: 14px;
            padding: 8px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div id="user-info">
        <h2>ğŸ‘‹ ä½ å¥½, <span id="name">åŠ è½½ä¸­...</span></h2>
        <p style="margin-top: 5px; font-size: 14px; opacity: 0.7;">Telegram ID: <span id="user-id">åŠ è½½ä¸­...</span></p>
    </div>

    <div class="card">
        <h3>ğŸ“Š å®æ—¶æ•°æ®æ¦‚è§ˆ</h3>
        <div class="data-grid">
            <div class="data-item">
                <div class="data-value">1830</div>
                <div class="data-label">ä»Šæ—¥è®¿å®¢</div>
            </div>
            <div class="data-item">
                <div class="data-value">$1000</div>
                <div class="data-label">ä»Šæ—¥è¥æ”¶</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>System Status</h3>
        <p>âœ… Server Online</p>
        <p>âœ… Database Connected</p>
    </div>

    <div class="card debug-panel">
        <h3>ğŸ” è°ƒè¯•æ—¥å¿—</h3>
        <button class="debug-toggle" onclick="toggleDebug()">éšè—/æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
        <div id="debug-logs"></div>
    </div>

    <button onclick="closeApp()">å…³é—­é¢æ¿</button>

    <script>
        // è‡ªå®šä¹‰æ—¥å¿—å‡½æ•° - åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œé¡µé¢
        const debugLogs = document.getElementById('debug-logs');
        
        function addLog(message, type = 'log') {
            // è¾“å‡ºåˆ°æ§åˆ¶å°
            if (type === 'error') {
                console.error(message);
            } else if (type === 'success') {
                console.log(message);
            } else {
                console.log(message);
            }
            
            // è¾“å‡ºåˆ°é¡µé¢
            const logDiv = document.createElement('div');
            logDiv.className = `debug-log ${type === 'error' ? 'debug-error' : type === 'success' ? 'debug-success' : ''}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const messageText = typeof message === 'object' ? JSON.stringify(message, null, 2) : String(message);
            logDiv.innerHTML = `<strong>[${timestamp}]</strong> ${messageText}`;
            
            debugLogs.appendChild(logDiv);
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            debugLogs.scrollTop = debugLogs.scrollHeight;
        }

        // åˆ‡æ¢è°ƒè¯•é¢æ¿æ˜¾ç¤º
        function toggleDebug() {
            const logs = document.getElementById('debug-logs');
            if (logs.style.display === 'none') {
                logs.style.display = 'block';
            } else {
                logs.style.display = 'none';
            }
        }

        // åˆå§‹åŒ– Telegram å¯¹è±¡
        addLog("å¼€å§‹åˆå§‹åŒ– Telegram WebApp...");
        addLog(`window.Telegram å­˜åœ¨: ${!!window.Telegram}`);
        addLog(`window.Telegram.WebApp å­˜åœ¨: ${!!(window.Telegram && window.Telegram.WebApp)}`);
        
        const tg = window.Telegram.WebApp;
        
        if (!tg) {
            addLog("âŒ Telegram WebApp å¯¹è±¡ä¸å­˜åœ¨ï¼", 'error');
        } else {
            addLog("Telegram WebApp å¯¹è±¡å·²æ‰¾åˆ°");
            tg.ready();
            tg.expand();
            addLog("Telegram WebApp å·²å°±ç»ª");
            
            // ç«‹å³æ£€æŸ¥ä¸€æ¬¡æ•°æ®
            addLog("=== ç«‹å³æ£€æŸ¥ Telegram æ•°æ® ===");
            addLog(`tg.initData: ${tg.initData ? "å­˜åœ¨" : "ä¸å­˜åœ¨"}`);
            addLog(`tg.initDataUnsafe: ${tg.initDataUnsafe ? "å­˜åœ¨" : "ä¸å­˜åœ¨"}`);
            if (tg.initDataUnsafe) {
                addLog(`tg.initDataUnsafe.user: ${tg.initDataUnsafe.user ? "å­˜åœ¨" : "ä¸å­˜åœ¨"}`);
                if (tg.initDataUnsafe.user) {
                    addLog(`ç”¨æˆ· ID: ${tg.initDataUnsafe.user.id || "æ— "}`);
                }
            }
        }

        // Google è¡¨å• URLï¼ˆå…¨å±€å˜é‡ï¼‰
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdll2f6VM-wnsSjPZ07DwVAFqOOV1rZbk-asx--7mvoo-2vjg/formResponse";

        // ä» initData å­—ç¬¦ä¸²ä¸­è§£æç”¨æˆ· IDï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰
        function parseUserIdFromInitData(initData) {
            try {
                if (!initData) return null;
                
                // initData æ ¼å¼é€šå¸¸æ˜¯: key=value&key=value&user=...
                const params = new URLSearchParams(initData);
                const userStr = params.get('user');
                
                if (userStr) {
                    const userObj = JSON.parse(decodeURIComponent(userStr));
                    return userObj.id || null;
                }
                
                // å°è¯•ç›´æ¥æŸ¥æ‰¾ id
                const idStr = params.get('id');
                if (idStr) {
                    return parseInt(idStr);
                }
                
                return null;
            } catch (error) {
                addLog(`è§£æ initData å¤±è´¥: ${error.message}`, 'error');
                return null;
            }
        }

        // è·å–å¹¶æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        function displayUserInfo(retryCount = 0) {
            const maxRetries = 20; // å¢åŠ åˆ°20æ¬¡
            const retryDelay = 300; // å¢åŠ åˆ°300ms
            
            // æ–¹æ³•1: ä» initDataUnsafe è·å–
            const user = tg.initDataUnsafe?.user;
            
            // æ–¹æ³•2: ä» initData å­—ç¬¦ä¸²è§£æ
            const tgInitData = tg.initData || "";
            let userIdFromInitData = null;
            if (tgInitData) {
                userIdFromInitData = parseUserIdFromInitData(tgInitData);
            }
            
            // è¯¦ç»†è°ƒè¯•ä¿¡æ¯
            addLog(`=== å°è¯•è·å–ç”¨æˆ·ä¿¡æ¯ (ç¬¬ ${retryCount + 1} æ¬¡) ===`);
            addLog(`tg.initDataUnsafe: ${tg.initDataUnsafe ? "å­˜åœ¨" : "ä¸å­˜åœ¨"}`);
            addLog(`tg.initDataUnsafe?.user: ${user ? "å­˜åœ¨" : "ä¸å­˜åœ¨"}`);
            addLog(`tg.initData: ${tgInitData ? "å­˜åœ¨ (" + tgInitData.length + " å­—ç¬¦)" : "ä¸å­˜åœ¨"}`);
            if (tgInitData) {
                addLog(`initData å‰100å­—ç¬¦: ${tgInitData.substring(0, 100)}`);
            }
            
            // ä¼˜å…ˆä½¿ç”¨ initDataUnsafe.user
            if (user && user.id) {
                // æˆåŠŸè·å–ç”¨æˆ·ä¿¡æ¯
                document.getElementById('name').innerText = user.first_name || "ç”¨æˆ·";
                document.getElementById('user-id').innerText = user.id;
                addLog(`âœ… æˆåŠŸè·å– Telegram ID: ${user.id} (ä» initDataUnsafe)`);
                addLog(`æ˜¾ç¤ºç”¨æˆ·å: ${user.first_name || "ç”¨æˆ·"}`);
                return true;
            } 
            // å¤‡ç”¨æ–¹æ³•ï¼šä» initData è§£æ
            else if (userIdFromInitData) {
                document.getElementById('name').innerText = "ç”¨æˆ·";
                document.getElementById('user-id').innerText = userIdFromInitData;
                addLog(`âœ… æˆåŠŸè·å– Telegram ID: ${userIdFromInitData} (ä» initData è§£æ)`);
                return true;
            }
            // å¦‚æœè¿˜æ²¡è·å–åˆ°ï¼Œç»§ç»­é‡è¯•
            else if (retryCount < maxRetries) {
                addLog(`ç­‰å¾… Telegram æ•°æ®åŠ è½½... (å°è¯• ${retryCount + 1}/${maxRetries})`);
                setTimeout(() => {
                    displayUserInfo(retryCount + 1);
                }, retryDelay);
                return false;
            } else {
                // é‡è¯•æ¬¡æ•°ç”¨å®Œï¼Œæ˜¾ç¤ºé”™è¯¯
                document.getElementById('name').innerText = "æœ¬åœ°è®¿å®¢";
                document.getElementById('user-id').innerText = "æœªè·å–";
                addLog("âŒ æœªè·å–åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œæ˜¾ç¤ºä¸ºæœ¬åœ°è®¿å®¢", 'error');
                addLog("âŒ Telegram ID: æœªè·å–", 'error');
                addLog(`è°ƒè¯•ä¿¡æ¯: initDataUnsafe=${!!tg.initDataUnsafe}, initData=${!!tgInitData}`);
                return false;
            }
        }

        // ç­‰å¾… Telegram WebApp å®Œå…¨åˆå§‹åŒ–
        function submitToGoogleForm(retryCount = 0) {
            try {
                addLog("å¼€å§‹æäº¤æ•°æ®åˆ° Google è¡¨å•...");
                
                // æ£€æŸ¥ Telegram WebApp æ˜¯å¦å¯ç”¨
                if (!window.Telegram || !window.Telegram.WebApp) {
                    addLog("âŒ Telegram WebApp æœªåˆå§‹åŒ–", 'error');
                    return;
                }

                const tgInitData = tg.initData || "";
                addLog(`tgInitData: ${tgInitData ? "å­˜åœ¨ (" + tgInitData.length + " å­—ç¬¦)" : "ä¸ºç©º"}`);
                if (tgInitData) {
                    addLog(`initData å†…å®¹: ${tgInitData.substring(0, 100)}...`);
                }

                // å®‰å…¨åœ°è·å–ç”¨æˆ·ä¿¡æ¯
                const user = tg.initDataUnsafe?.user;
                addLog(`user å¯¹è±¡: ${user ? "å­˜åœ¨" : "ä¸å­˜åœ¨"}`);
                
                if (user) {
                    addLog(`ğŸ“± Telegram ID: ${user.id || "æœªçŸ¥"}`);
                    addLog(`ç”¨æˆ·ä¿¡æ¯: ${JSON.stringify({
                        id: user.id,
                        first_name: user.first_name,
                        username: user.username || 'æ— '
                    })}`);
                }

                // å¦‚æœç”¨æˆ·ä¿¡æ¯è¿˜æ²¡å‡†å¤‡å¥½ï¼Œé‡è¯•ï¼ˆæœ€å¤š5æ¬¡ï¼‰
                if (!user && retryCount < 5) {
                    addLog(`ç­‰å¾…ç”¨æˆ·ä¿¡æ¯åŠ è½½... (é‡è¯• ${retryCount + 1}/5)`);
                    setTimeout(() => {
                        submitToGoogleForm(retryCount + 1);
                    }, 500);
                    return;
                }

                if (!user) {
                    addLog("âŒ æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œtg.initDataUnsafe.user ä¸º undefined", 'error');
                    return;
                }

                const userId = user.id;
                addLog(`userId: ${userId}`);

                if (!userId) {
                    addLog("âŒ userId ä¸ºç©ºï¼Œæ— æ³•æäº¤è¡¨å•", 'error');
                    return;
                }

                // ä½¿ç”¨ URLSearchParams æäº¤
                const params = new URLSearchParams();
                params.append("entry.1978516627", String(userId));
                params.append("entry.780678217", tgInitData || "");

                addLog("å‡†å¤‡æäº¤æ•°æ®åˆ° Google è¡¨å•...");
                addLog(`æäº¤çš„æ•°æ®: userId=${userId}, initDataé•¿åº¦=${tgInitData ? tgInitData.length : 0}`);
                addLog(`æäº¤ URL: ${GOOGLE_FORM_URL}`);
                addLog(`æäº¤å‚æ•°: ${params.toString().substring(0, 200)}...`);

                // ä½¿ç”¨ URLSearchParams å’Œæ­£ç¡®çš„ Content-Type
                fetch(GOOGLE_FORM_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: params.toString()
                }).then(() => {
                    addLog("âœ… æ•°æ®å·²æäº¤åˆ° Google è¡¨å• (æ³¨æ„ï¼šno-cors æ¨¡å¼ä¸‹æ— æ³•ç¡®è®¤æ˜¯å¦çœŸæ­£æˆåŠŸ)", 'success');
                }).catch(err => {
                    addLog(`âŒ æäº¤å¤±è´¥: ${err.message || err}`, 'error');
                });

            } catch (error) {
                addLog(`âŒ æäº¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message || error}`, 'error');
                addLog(`é”™è¯¯å †æ ˆ: ${error.stack || 'æ— '}`, 'error');
            }
        }

        // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿ Telegram WebApp å®Œå…¨åŠ è½½
        // ä½¿ç”¨ setTimeout ç¡®ä¿åœ¨é¡µé¢å®Œå…¨åŠ è½½åå†æ‰§è¡Œ
        function startInitialization() {
            addLog("=== å¼€å§‹åˆå§‹åŒ–æµç¨‹ ===");
            // ç«‹å³å°è¯•ä¸€æ¬¡
            displayUserInfo();
            // å»¶è¿Ÿæäº¤è¡¨å•
            setTimeout(submitToGoogleForm, 2000);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                addLog("é¡µé¢ DOM åŠ è½½å®Œæˆ");
                // ç«‹å³å¼€å§‹ï¼Œä¸å»¶è¿Ÿ
                startInitialization();
            });
        } else {
            addLog("é¡µé¢å·²åŠ è½½ï¼Œç«‹å³å¼€å§‹åˆå§‹åŒ–");
            // ç«‹å³å¼€å§‹ï¼Œä¸å»¶è¿Ÿ
            startInitialization();
        }

        // å…³é—­åŠŸèƒ½
        function closeApp() {
            tg.close();
        }
    </script>
</body>
</html>